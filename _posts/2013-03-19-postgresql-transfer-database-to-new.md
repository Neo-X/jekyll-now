---
layout: post
title: Postgresql Transfer Database to New Tablespace with Python
date: '2013-03-19T08:34:00.000-07:00'
author: Glen B
tags: 
modified_time: '2013-07-10T12:28:30.597-07:00'
blogger_id: tag:blogger.com,1999:blog-2030049895335802245.post-6855584773184781162
blogger_orig_url: http://fracturedplane.blogspot.com/2013/03/postgresql-transfer-database-to-new.html
---

This is a quick script I wrote in python to generate the sql file needed to transfer one database to another tablespace.<br /><br /><br /><pre class="prettyprint"><code class="language-py"><br />&nbsp;#!/usr/bin/python<br /><br /># will generate the sql file needed to alter the tablespace for a database.<br /><br />import psycopg2<br />import psycopg2.extras<br />import sys<br /><br />#<br /># Configuration<br /># <br />host = '<provide-me>';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # The host on which the database resides.<br />user = '<provide-me>';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # The username to access the database.<br />password = '<provide-me>';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # The password to access the database.<br />db = '<provide-me>';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # The database to move.<br />tablespace = '<provide-me>';&nbsp;&nbsp;&nbsp; # The tablespace to move the database to.<br />output = ""<br /><br />#<br /># Application<br />#<br />conn = psycopg2.connect(database=db, user=user, password=password)<br />conn.set_isolation_level(0)&nbsp; <br />cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)<br /><br /># Create SQL code to put new tables and indexes in the new tablespace.<br />output = output + "ALTER DATABASE " + db + " SET default_tablespace = " + tablespace + ";\n"<br /><br /># Select all tables from the database.<br />tableQuery = "SELECT * FROM pg_tables where tableowner='" + user + "' ORDER BY tablename"<br /><br />cur.execute(tableQuery)<br /><br />db_tables = cur.fetchall()<br /># print db_tables <br />for table in db_tables:<br />&nbsp;&nbsp;&nbsp; schemaName = table['schemaname']<br />&nbsp;&nbsp;&nbsp; tableName = table['tablename']<br /><br />&nbsp;&nbsp;&nbsp; # Create SQL code to move the table to the new tablespace.<br />&nbsp;&nbsp;&nbsp; output = output + "ALTER TABLE "+ schemaName +"." + tableName + " SET TABLESPACE " + tablespace + ";\n";<br />&nbsp;&nbsp;&nbsp; # print output<br /><br />&nbsp;&nbsp;&nbsp; # Select all indexes from the table.<br />&nbsp;&nbsp;&nbsp; indexQuery = "SELECT * FROM pg_indexes WHERE schemaname = '" + schemaName + "' AND tablename = '" + tableName + "' ORDER BY indexname"<br />&nbsp;&nbsp;&nbsp; print indexQuery<br />&nbsp;&nbsp;&nbsp; cur.execute(indexQuery)<br />&nbsp;&nbsp;&nbsp; print cur.statusmessage<br />&nbsp;&nbsp;&nbsp; db_indexes = cur.fetchall()<br />&nbsp;&nbsp;&nbsp; # print db_indexes<br />&nbsp;&nbsp;&nbsp; for index in db_indexes:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print dict(index)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; indexName = index['indexname']<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Create SQL code to move the index to the new tablespace.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; output = output + "ALTER INDEX " + schemaName + "." + indexName + " SET TABLESPACE " + tablespace+ ";\n";<br />&nbsp;&nbsp;&nbsp; <br /><br /><br /># Write the resulting SQL code to a file.<br />filename = 'migrate_' + host + '_' + db + '_to_' + tablespace + '.sql'<br />sqlfile = open('filename, 'w')<br />sqlfile.write(output)<br /><br />&nbsp;</provide-me></provide-me></provide-me></provide-me></provide-me><br /><br /></code></pre><br />Best of luck.<br /><code></code> <br /><code></code> <br /><code>References:</code><br /><ol><li><code>http://blog.lodeblomme.be/2008/03/15/move-a-postgresql-database-to-a-different-tablespace/</code></li><li><code>http://www.postgresql.org/docs/9.1/static/sql-createtablespace.html </code></li></ol>