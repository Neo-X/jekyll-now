---
layout: post
title: 'SmartBody Example:'
date: '2013-03-06T10:13:00.001-08:00'
author: Glen B
tags: 
modified_time: '2013-03-06T10:26:11.797-08:00'
blogger_id: tag:blogger.com,1999:blog-2030049895335802245.post-2423063221605517989
blogger_orig_url: http://fracturedplane.blogspot.com/2013/03/smartbody-example.html
---

<br />SmartBody characters are usually controlled via python scripts. These scripts are responsible for loading all of the features need for the character animation and then seting up the character in the environment and last functions to control the actions of the character(s).<br /><br />This is a common exmaple, there are more advanced features than what is discussed in this post.<br /><br />The first part of the python script to control a SmartBody character should be calls to add any assests that are need for the character animations that will be used later in the script.<br /><br /><pre class="prettyprint"><code class="language-py"><br />smartBodyRelitivePath = "../../smartbody/data/"<br /><br /># Add asset paths<br />scene.addAssetPath('script',smartBodyRelitivePath + 'sbm-common/scripts')<br />scene.addAssetPath('mesh', smartBodyRelitivePath + 'mesh')<br />scene.addAssetPath('mesh', smartBodyRelitivePath + 'retarget/mesh')<br />scene.addAssetPath('motion', smartBodyRelitivePath + 'ChrBrad')<br />scene.addAssetPath('motion', smartBodyRelitivePath + 'ChrRachel')<br />scene.addAssetPath('motion', smartBodyRelitivePath + 'retarget\motion')<br />scene.addAssetPath('motion', smartBodyRelitivePath + 'sbm-common/common-sk')<br />scene.loadAssets()<br /></code></pre><br /><br />The above code first defines the relative path to the directory that contain all of the assest for character animation. These include meshes, skeletal meshes, joint maps, etc. These are usually stored in the data folder in SmartBody. As can bee seen assets for the mesh for a character is added as well as common script for that character and motion data that will be used to create the motion of the character.<br /><br />The next section of the program Will configure the scene. This is much more OpenGL like and is to define the setting for the camera.<br /><br /><pre class="prettyprint"><code class="language-py"><br /># Set scene parameters and camera<br />print 'Configuring scene parameters and camera'<br />scene.setScale(1.0)<br />scene.setBoolAttribute('internalAudio', True)<br />scene.run('default-viewer.py')<br />camera = getCamera()<br />camera.setEye(0, 2.87, 11.67)<br />camera.setCenter(0, 2.14, 9.81)<br />camera.setUpVector(SrVec(0, 1, 0))<br />camera.setScale(1)<br />camera.setFov(1.0472)<br />camera.setFarPlane(100)<br />camera.setNearPlane(0.1)<br />camera.setAspectRatio(0.966897)<br />scene.getPawn('camera').setPosition(SrVec(0, -5, 0))<br /></code></pre><br /><br />The next section is a little less obvious. It first runs a script, this script loads a joint map. After a joint map is loaded it can be applied to a character in SmartBody.<br /><br /><pre class="prettyprint"><code class="language-py"><br /># Set joint map for Brad<br />print 'Setting up joint map for Brad'<br />scene.run('zebra2-map.py')<br />zebra2Map = scene.getJointMapManager().getJointMap('zebra2')<br />bradSkeleton = scene.getSkeleton('ChrBrad.sk')<br />zebra2Map.applySkeleton(bradSkeleton)<br />zebra2Map.applyMotionRecurse('ChrBrad')<br /></code></pre><br /><br />Next two more scripts are run to setup the motion animation that the character can do and next activates the parametric animation that is used for the characters.<br /><br /><pre class="prettyprint"><code class="language-py"><br /># Retarget setup<br />scene.run('motion-retarget.py')<br /># Animation setup<br />scene.run('init-param-animation.py')<br /></code></pre><br /><br />Now everything that needs to be done to be able to use animations is complete The last step that needs to be done so that a character can be used in the scene is described below.<br /><br /><pre class="prettyprint"><code class="language-py"><br /># Set up Brads<br /><br />print 'Adding characters into scene'<br />posX = -200<br />for i in range(1): # Only add one brad<br />&nbsp;&nbsp;&nbsp; baseName = 'ChrBrad%s' % i<br />&nbsp;&nbsp;&nbsp; brad = scene.createCharacter(baseName, '')<br />&nbsp;&nbsp;&nbsp; bradSkeleton = scene.createSkeleton('ChrBrad.sk')<br />&nbsp;&nbsp;&nbsp; brad.setSkeleton(bradSkeleton)<br />&nbsp;&nbsp;&nbsp; # Set position<br />&nbsp;&nbsp;&nbsp; bradPos = SrVec((posX + (i * 200))/100, 0, 0)<br />&nbsp;&nbsp;&nbsp; brad.setPosition(bradPos)<br />&nbsp;&nbsp;&nbsp; # Set up standard controllers<br />&nbsp;&nbsp;&nbsp; brad.createStandardControllers()<br />&nbsp;&nbsp;&nbsp; # Set deformable mesh<br />&nbsp;&nbsp;&nbsp; brad.setDoubleAttribute('deformableMeshScale', .01)<br />&nbsp;&nbsp;&nbsp; brad.setStringAttribute('deformableMesh', 'ChrBrad')<br />&nbsp;&nbsp;&nbsp; # Play idle animation<br />&nbsp;&nbsp;&nbsp; bml.execBML(baseName, '<body posture="ChrBrad@Idle01">')<br />&nbsp;&nbsp;&nbsp; # Retarget character<br />&nbsp;&nbsp;&nbsp; retargetCharacter(baseName, 'ChrBrad.sk', False)</body><br /><br /><br /><br /># Turn on GPU deformable geometry for all<br />for name in scene.getCharacterNames():<br />&nbsp;&nbsp;&nbsp; scene.command("char %s viewer deformableGPU" % name)<br /></code></pre><br /><br />To add a character to the scene it needs to have a unique name ( will be seen later why ) and must be assigned a skeleton. THe rest of the code sets up the initial conditions for the character Brad: initial position, standard controllers, scale and turn on deformable geometry (by default a characters geometry is not displayed) and the initial posture for brad. A posture is the stance the character will take when no other animations are in effect.<br /><br /><br />The last part of the script is the part that you must write. After the characters have been initialized properly it is up to you to control the character as you want. For this example I wrote a simple controller that accepts information from a TCP connection so that I can control the character with another program.<br /><br /><br /><pre class="prettyprint"><code class="language-py"><br />class LocomotionDemo(SBScript):<br />&nbsp;&nbsp;&nbsp; def update(self, time):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Select is a creative way of checking to see if a service has data ready to read,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # ready to write to or an exceptional condition.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r, w, e = select.select([service], [], [], 0.0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if r: # There is something to read<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data = service.recv(256)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; character = 'ChrBrad0'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # The last 0 in the target is zero just so the character stays on the plane<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bmlMessage = '<locomotion manner="jog" target="' + data + ' 0'+ '" type="basic">'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print "BML Message for " + character + ": " + bmlMessage<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bml.execBML(character, bmlMessage)</locomotion><br /></code></pre><br /><br />To add a controlling script you need to write a class and have a method called update in that class. This update method will be called every frame and you can check the characters and scene for events of interest to further animate your characters. THe code include some notes on some features of Python.<br /><br />Last the script that you have created need to be given control. This is done by explicitely removing the script name if it already exsist and then creating an object that can be used to reference your update function.<br /><br />NOTE: this script name is for the class that is created not the name of script file that is be used.<br /><br /><br /><pre class="prettyprint"><code class="language-py"><br /># Run the update script<br />scene.removeScript('locomotiondemo')<br />locomotiondemo = LocomotionDemo()<br />scene.addScript('locomotiondemo', locomotiondemo)<br /></code></pre><br /><br /><br /><br />References<br /><ol><li>http://smartbody.ict.usc.edu/forum</li><li>http://smartbody.ict.usc.edu</li></ol>